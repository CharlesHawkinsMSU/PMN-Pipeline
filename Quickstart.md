# Quickstart

This is a quick set of steps to get up and running with the PMN pipeline. A full manual with all available options and troubleshooting steps is in Manual.md. For this we will be building and running the Singularity container version of the pipeline, and running it on a single species.

## What you'll need

To run the pipeline, you will need an x86_64-based computer with Linux. You will need to download the pipeline build scripts, and get a copy of Pathway Tools. You will then need a set of full amino acid sequences from your organism of interest.

## Getting ready

### Get the build scripts

Go to a directory where you keep github projects and type:

    git clone 'https://github.com/CharlesHawkinsMSU/pmn-container'
    cd pmn-container

### Recommended: symlink the pmn.sh script

To be able to call the pipeline by just typing `pmn`, you can make a symlink from the pmn.sh script to somewhere in your PATH. So for example:

    sudo ln -s pmn.sh /usr/local/bin/pmn

The pmn.sh script is a convenience script that lives outside the container and lets you build and run it without having to set up your environment yourself.

### Download Pathway Tools

Request a Pathway Tools license from http://bioinformatics.ai.sri.com/ptools. They should send you a download link in a day or two. Download pathway-tools-28.0-linux-64-tier1-install and put it in the pmn-container folder.

### Build the container

Build the pipeline with:

    pmn build

(if you use apptainer instead of singularity, prepend it with `SINGULARITY=apptainer`)

It should take some time but will produce pmn-ptools.sif. You can now set up your project for a pipeline run.

## Set up your pipeline run

### Create a new project

Navigate to wherever you want the project to be. We will call our project pmntestrun.

    mkdir pmntestrun
    cd pmntestrun
    pmn newproj

This will populate the new project with some directories and default config files.

### Download the genome annotation

For this example we're going to use the sweet orange (*Citrus sinensis*) genome 1.1 from Phytozome (https://phytozome-next.jgi.doe.gov/info/Csinensis_v1_1), but you can use any plant or green alga genome you want as long as it has a full protein annotation; just replace the species name, filenames, and other species-specific values.

Download Csinensis_154_protein.fa.gz from Phytozome, unzip Csinensis_154_protein.fa, and put it in the fasta directory of the new project.

### Download PlantCyc and AraCyc

Copies of PlantCyc and AraCyc are needed to run the pipeline. Request a (free) license at https://plantcyc.org/downloads/license-agreement, download plantcyc and aracyc from the link emailed to you, and place them in the pgdbs directory of the project.

### Edit the project config files

Now we need to change the default config files generated by the newproj command to reflect the genome we want to run. First, edit pmn-pipeline.txt and uncomment the line that says split-fa-num-files = 20 (i.e. remove the # at the beginning). Everything else in this file can stay as-is.

Next, edit pgdb-table.txt. This is a tab-delimited text file, so you can import it into a spreadsheet program to edit, just be sure to export with tab as the delimiter and no quote marks around the fields.

The default file has two example lines, for Arabidopsis and tomato. Delete tomato and edit the Arabidopsis line to match sweet orange as follows:

- Under the Database ID column, put 'SweetOrange'. This will name our database SweetOrangeCyc
- Under the Species Name column, put 'Citrus sinensis'
- Under the NCBI Taxon ID column, put 2711. Phytozome lists this in the organism info page linked above, or you can search (https://www.ncbi.nlm.nih.gov/taxonomy) for your speces
- Under the Sequence File column, put Csinensis_154_protein.fa
- Under the Version column, put 1.0
- Under the Seq Source column, put PHYTOZOME
- Under the Genes From column, put Map
- Under the Map In column (create it if it doesn't exist), put Csinensis.map (we will create this file)
- Under the Citation Year column, put the current year
- Under the authors column, put a list of author IDs for who you want to be credited for this PGDB, in vertical bars, separated by spaces. You can pick anything for them, but the last names in all lower case are fine. So for example |hawkins| |xue| |rhee|. We will give the actual author details for these author IDs in authors.txt

Next, edit authors.txt. This file is used to give the names and info of all authors credited with a PGDB in pgdb-table.txt. Clear the default authors and put in rows for the authors you want to credit:

- Under FrameID put the author ID you gave in pgdb-table.txt, in vertical bars, e.g. |hawkins|
- Put the first and last name of each author under First-Name and Last-Name
- Put something under Login-Account for each one; usually this is the user name on your local computer. Pathway Tools requires this to be filled but it won't actually matter for the pipeline
- Put an institution ID in Affiliations. This column is to give affiliations to each author. We will fill the details out in organizations.txt. The ID itself doesn't matter, it's just to reference a line in organizations.txt

Finally, edit organizations.txt. For each organization given as an Affiliation in authors.txt, fill out the info as follows:
 - Under FrameID, put whatever ID you picked to use for the organization in authors.txt
 - Under common-name, put the full name of the organization, like Michigan State University
 - Under abbreb-name, put an abbreviation for the organization, like MSU
 - Under url, put the front-page url of the organization's website, like https://msu.edu
 - Under email, put an email the organization can be reached at

### Create the protein-gene map
The *C. sinensis* 1.1 genome has gene IDs that are the protein IDs with g. added to the front; based on this we will write a small awk script to create a mapping file from the gene to protein IDs, required by the pipeline:

    cat fasta/Csinensis_154_protein.fa | awk -F '|' '$1 ~ />/ {sub(">","",$1); print "g." $1 "\t" $1}' > maps-in/Csinensis.map

## Run the pipeline

Now we can run the pipeline. It is possible to run it all at once, but we will run it in steps to see the effects of each stage. First, let's have it check that the initial setup and config files look okay. Run:

    pmn precheck

If there are errors, the Troubleshooting section in the full manual may be of help. Once this step runs without errors, we can continue.

Next, we will split the input fasta files into smaller parts, which are easier for E2P2 to work with:

    pmn split

Next up is to run E2P2. This is the most computationally intensive stage. Run it with:

    pmn e2p2 -s all

If it runs without errors, join the split E2P2 output files with:

    pmn join

We should now have Csinensis_154_protein.fa.MaxWeightAbsoluteThreshold.orxn.pf in the e2p2 folder. We now need to revise this .pf file to put in the gene IDs we gave in the mapping file earlier:

    pmn revise

This generates e2p2/Csinensis_154_protein.fa.e2p2.orxn.revised.pf with the gene and protein IDs in their proper places in the file.

Now we need to generate a unique ID for each database. These are used internally by Pathway Tools to indicate where database objects (frames) originated from. To generate them, use:

    pmn unique-ids

This will create uids.txt which contains the generated unique IDs.

We can now prepare to generate the initial database with:

    pmn prepare

This generates some files in pgdb-masters and copies the .pf and fasta files there for PathoLogic to find. Run PathoLogic to create the database:

    pmn create

This will create the initial database and put it in pgdbs/sweetorangecyc. If you have your own install of Pathway Tools, you can copy the initial sweetorangecyc there and inspect it if you wish; just copy the directory into ptools-local/pgdbs/user/ (wherever you placed that during install) and launch Pathway Tools.

There is, however, more to do. The next step is SAVI. This is an opportunity to show running multiple stages at once. We will run three stages; one to dump the flat files, which SAVI needs in order to run; one to copy all the needed files into the savi/input/SweetOrange directory so that savi can find them; and one to run savi:

    pmn savi-dump savi-prepare savi

This should generate some output files in savi/output/SweetOrange, the most important being ic.txt and remove.txt, the list of pathways to add and remove, respectively (ic stands for inferred by curator, the evidence code that will be assigned to pathways added at the behest of SAVI). The actual changes will be made during refine-a.

Next are the refine steps. Fist we must prepare for them with:

    pmn refine-prepare

This will copy the savi results into the pgdb-masters/ directories, generate common files for the refine steps, and generate author, organization, and citation info in AraCyc to be copied to the databases of interst.

Next we can run refine-a:

    pmn refine-a

This step applies SAVI's changes, puts in citations for E2P2 and SAVI, and makes other needed refinements. The next thing to run is refine-b:

    pmn refine-b

This step looks through PlantCyc and MetaCyc for any pathways and proteins with experimental evidence for *Citrus sinensis* and imports them into the new database.

The final refine step is refine-c:

    pmn refine-c

This step runs Pathway Tools' consistency checker and generates the cellular overview. It is fairly computationally intensive and may take a while to run.

Once this runs, we will have a finished database. There are a couple more things we may want to do. To dump all the flatfiles, convenient for analyzing the database's contents using external tools, run:

    pmn final-dump

If you want to generate blast databases to search for enzymes by sequence similarity, you can run:

    pmn blastset

The blast databases will be put in the blastsets/ directory.

If you want to generate the big tabular custom dump files for pathways and compounds, like the ones linked to at (https://plantcyc.org/downloads?qt-downloads=0#qt-downloads) under "tab-delimited text files", run:

    pmn custom-dumps

Congratulations! You now have a finished PMN-style pathway genome database with all the bells and whistles.

## Inspect and use your PGDB

To inspect and use your new database, you will want to install Pathway Tools on your computer. This done, you can move pgdbs/sweetorangecyc into the ptools-local/pgdbs/user/ directory of your Pathway Tools install. Now launch Pathway Tools as normal and SweetOrangeCyc should show up in the list of available databases.

The web interface is convenient for working with such databases. To run Pathway Tools in web mode, go to the pathway-tools folder in your terminal and run:

    ./ptwww

Once the Pathway Tools window opens (indicating it has finished starting up), you can go to https://localhost:1555 in your browser to access the Pathway Tools instance. You should be able to select *Citrus sinensis* from the organism list.
