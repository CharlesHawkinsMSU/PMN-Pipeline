#!/bin/bash
# This is the general script for running the PMN pipeline

function help() {
	if [[ -z $2 ]]; then
		echo "Usage: $(basename $1) cmd [cmd-specific options]"
		echo ""
		echo "Runs the PMN pipeline. Recognized commands:"
		echo "help	Print this help text and exit, or get help on another command"
		echo "busco	Run BUSCO on the specified protein fasta file"
		echo "e2p2	Run E2P2 on the specified protein fasta file"
	elif [[ $2 == "busco" ]]; then
		echo "Usage: $(basename $1) busco input.fa [output.fa.busco]"
		echo ""
		echo "Run BUSCO on the specified protein fasta file input.fa. Output will be to a folder; if no output folder name is given the name will be generated by appending .busco to the input name (e.g. input.fa.busco). BUSCO will be run with the ${PMN_BUSCO_DB:-[error: db not set]} database in protein mode."
		echo ""
		echo "BUSCO is a quality assessment tool for sequenced genomes (https://busco.ezlab.org/). It uses a database of proteins that are conserved within a particular clade (in this case $PMN_BUSCO_DB) and uses HMMER to look for orthologs of thse proteins in the specified genome. On the assumption that the real genome should actually contain orthologs for all the proteins in the database, the percentage of them that HMMER successfully finds is taken to be a good proxy measure for the overall percentage of the genome that the sequencing effort recovered successfully. PMN uses a cutoff of 75% to include a genome in our network."
	elif [[ $2 == "e2p2" ]]; then
		echo "Usage: $(basename $1) e2p2 input.fa [output.fa.e2p2v4]"
		echo ""
		echo "Run E2P2 on the specified protein fasta file input.fa. Several output files will be generated, all with names starting with the specified output name (if not given, the output name will be the input name + .e2p2v4). The file output.fa.e2p2v4.orxn.pf is the one used in subsequent steps"
		echo ""
		echo "E2P2 (the Ensemble Enzyme Prediction Pipeline) is software published by PMN to predict enyzyme functions from protein sequences (https://plantcyc.org/about/documentation/e2p2-description). At present it uses blastp and PRIAM with a custom weighting scheme to make predictions. Predictions are based on the Reference Protein Sequence Dataset (RPSD), assembled by PMN from various sources, that contains sequences of known enzymes (based on experimental evidence) and the reactions they are known to catalyze"
	elif [[ $2 == "revise" ]]; then
		$PMN_BIN/revise_pf.py -h
	else
		echo "Unrecognized command: $2"
	fi
}

cmd=$1
echo "Command: $cmd"
cmd_args=("${@:2}")
echo "Args:" ${cmd_args[@]}
case $cmd in
	help)
		help $0 ${cmd_args[0]}
		exit 0
		;;
	newproj)
		dir=${cmd_args[0]:-.}
		if [[ ! -a $dir ]]; then
			mkdir -p $dir
		fi
		cp -r $PMN_PGP/project-template/* $dir
		;;
	busco)
		busco \
			-i ${cmd_args[0]} \
			-o ${cmd_args[1]:-${cmd_args[0]}.busco} \
			-m protein \
			-l ${PMN_BUSCO:?Error: variable \$PMN_BUSCO not set}/$PMN_BUSCO_DB \
			-f \
			--offline
		;;
	e2p2)
		$PMN_E2P2/pipeline/run_pipeline.py \
			--input ${cmd_args[0]} \
			--output ${cmd_args[1]:-${cmd_args[0]}.e2p2v4} \
			--blastp ${PMN_E2P2_BLASTP:-blastp} \
			--java java \
			--priam_search $PMN_E2P2/PRIAM_search.jar \
			--priam_profile $PMN_E2P2/rpsd_current/profiles \
			--rpsd $PMN_E2P2/rpsd_current/blastdb/rpsd-${PMN_E2P2_RPSD}.fasta
		;;
	revise)
		$PMN_BIN/revise_pf.py ${cmd_args[@]}
		;;
	create-prepare)
		$PMN_BIN/pgdb-prepare.pl ${cmd_args[0]:-pgdb-table.txt} ${cmd_args[1]:-e2p2} ${cmd_args[2]:-pgdb-masters} ${cmd_args[3]:-$PT_EXE} ${cmd_args[4]:-$PGDBS}
		;;
	create)
		$PMN_BIN/create-pgdbs.pl ${cmd_args[0]:-pgdb-masters} ${cmd_args[1]:-1}
		;;
	*)
		$PMN_BIN/pmn-pipeline $cmd
		;;
esac
