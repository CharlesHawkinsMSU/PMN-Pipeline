(defparameter pmn13 '(WheatD Ahypochondriacus Amborella Cashew Pineapple Acoerulea Ahalleri Alyrata Ara Asparagus Sugarbeet Bstricta Brachypodium Oilseedrape Boleracea_capitata Boleracea_oleracea Brapa_fpsc Chinesecabbage Cgigantea Cacuminata Csativa_pk Cgrandiflora Crubella Cannuum Papaya Croseus Quinoa Chlamy Czofingiensis Carietinum_icc4958 Clementine Sweetorange Csubellipsoidea Ccapsularis Cucumber Carrot Carnation Drotundata Egrandis Esalsugineum Fvesca_vesca Soy Graimondii Sunflower Barley Hop Kfedtschenkoi Klaxiflora Lperrieri Flax Ljaponicus Mdomestica Cassava Mpolymorpha Mtruncatula Mcommoda Mpusilla Mguttatus Msinensis Banana Ntabacum_tn90 Oeuropaea_sylvestris Othomaeum Obrachyantha Oglaberrima Opunctata Orufipogon Oryza Olucimarinus Phallii Switchgrass Paxillaris Commonbean Moss Poplar Ppersica Castorbean Rchinensis Rmultiflora Redsage Selaginella Setaria Sviridis Tomato Eggplant Spennellii Potato Sorghumbicolor Sfallax Soleracea Spirodela Tparvula Cocoa Redclover Breadwheat WheatA Grape Vcarteri Corn Zmarina) "A list of all species in PMN13")
(defparameter pmn14 '(Ler Acoerulea Pineapple WheatD Ahalleri Ahypochondriacus Alyrata Cashew Asparagus Ara Amborella Mosobamboo Brachypodium Sugarbeet Boleracea_capitata Brapa_fpsc Oilseedrape Boleracea_oleracea Chinesecabbage Bstricta Carietinum_icc4958 Cacuminata Pigeonpea Cgigantea Csativa_pk Clementine Cgrandiflora Cvariabilis Muskmelon Ccapsularis Papaya Quinoa Chlamy Croseus Crubella Cucumber Sweetorange Tea Csubellipsoidea Czofingiensis Ccampestris Carnation Carrot Drotundata Egrandis Esalsugineum Fvesca_vesca Mtruncatula Sacredlotus Spiderflower Corkoak Mdomestica Ginkgo Soy Graimondii Sunflower Rubbertree Barley Hop Tomato Kfedtschenkoi Klaxiflora Lperrieri Ljaponicus Lettuce Flax Cassava Mguttatus Mpolymorpha Mpusilla Msinensis Mcommoda Banana Ntabacum_tn90 Rchinensis Oeuropaea_sylvestris Olucimarinus Obarthii Obrachyantha Oglaberrima Olongistaminata Omeridionalis Onivara Opunctata Orufipogon Oryza Othomaeum Sweetcherry Datepalm Cannuum Paxillaris Phallii Mbalbisiana Moss Ppersica Oilpalm Poplar Switchgrass Commonbean Europeanpear Valleyoak Castorbean Rmultiflora Redsage Sorghumbicolor Sfallax Setaria Eggplant Selaginella Spennellii Soleracea Spirodela Wildsugarcane Potato Sviridis Cocoa Redclover Tparvula Breadwheat WheatA Vcarteri Grape Watermelon Corn Zmarina) "A list of all species in PMN14")
(defparameter pmn15 '(Stora Ler Acoerulea Pineapple WheatD Ahalleri Ahypochondriacus Alyrata Cashew Asparagus Ara Amborella Mosobamboo Brachypodium Sugarbeet Boleracea_capitata Brapa_fpsc Oilseedrape Boleracea_oleracea Chinesecabbage Bstricta Carietinum_icc4958 Cacuminata Pigeonpea Cgigantea Csativa_pk Clementine Cgrandiflora Cvariabilis Muskmelon Ccapsularis Papaya Quinoa Chlamy Croseus Crubella Cucumber Sweetorange Tea Csubellipsoidea Czofingiensis Ccampestris Carnation Carrot Drotundata Egrandis Esalsugineum Fvesca_vesca Mtruncatula Sacredlotus Spiderflower Corkoak Mdomestica Ginkgo Soy Graimondii Sunflower Rubbertree Barley Hop Tomato Kfedtschenkoi Klaxiflora Lperrieri Ljaponicus Lettuce Flax Cassava Mguttatus Mpolymorpha Mpusilla Msinensis Mcommoda Banana Ntabacum_tn90 Rchinensis Oeuropaea_sylvestris Olucimarinus Obarthii Obrachyantha Oglaberrima Olongistaminata Omeridionalis Onivara Opunctata Orufipogon Oryza Othomaeum Sweetcherry Datepalm Cannuum Paxillaris Phallii Mbalbisiana Moss Ppersica Oilpalm Poplar Switchgrass Commonbean Europeanpear Valleyoak Castorbean Rmultiflora Redsage Sorghumbicolor Sfallax Setaria Eggplant Selaginella Spennellii Soleracea Spirodela Wildsugarcane Potato Sviridis Cocoa Redclover Tparvula Breadwheat WheatA Vcarteri Grape Watermelon Corn Zmarina) "A list of all species in PMN15")
(defparameter pmn16 '(Stora Ler Acoerulea Pineapple WheatD Ahalleri Ahypochondriacus Alyrata Cashew Asparagus Ara Amborella Mosobamboo Brachypodium Sugarbeet Boleracea_capitata Brapa_fpsc Oilseedrape Boleracea_oleracea Chinesecabbage Bstricta Carietinum_icc4958 Cacuminata Pigeonpea Cgigantea Csativa_pk Clementine Cgrandiflora Cvariabilis Muskmelon Ccapsularis Papaya Quinoa Chlamy Croseus Crubella Cucumber Sweetorange Tea Csubellipsoidea Czofingiensis Ccampestris Carnation Carrot Drotundata Egrandis Esalsugineum Fvesca_vesca Mtruncatula Sacredlotus Spiderflower Corkoak Mdomestica Ginkgo Soy Graimondii Sunflower Rubbertree Barley Hop Tomato Kfedtschenkoi Klaxiflora Lperrieri Ljaponicus Lettuce Flax Cassava Mguttatus Mpolymorpha Mpusilla Msinensis Mcommoda Banana Ntabacum_tn90 Rchinensis Oeuropaea_sylvestris Olucimarinus Obarthii Obrachyantha Oglaberrima Olongistaminata Omeridionalis Onivara Opunctata Orufipogon Oryza Othomaeum Sweetcherry Datepalm Cannuum Paxillaris Phallii Mbalbisiana Moss Ppersica Oilpalm Poplar Switchgrass Commonbean Europeanpear Valleyoak Castorbean Rmultiflora Redsage Sorghumbicolor Sfallax Setaria Eggplant Selaginella Spennellii Soleracea Spirodela Wildsugarcane Potato Sviridis Cocoa Redclover Tparvula Breadwheat WheatA Vcarteri Grape Watermelon Corn Zmarina Garlic Aagrestis_Bonn Aagrestis_oxford Apunctatus Aangustus SweetWormwood Jackfruit Breadfruit Afilliculoides Camelina Draba Teff AppleRingAcacia Strawberry GamNui Alyssum Moringa PocketWaterLily MexicanAvocado HaasAvocado HuskTomato BlackPepper Rosemary Watermoss Rye CoastRedwood Vanilla BambaraBean) "A list of all species in PMN16")
(defparameter pmn14-new '(Ler Pigeonpea Tea Cvariabilis Watermelon Muskmelon Ccampestris Oilpalm Ginkgo Rubbertree Lettuce Mbalbisiana Sacredlotus Obarthii Olongistaminata Omeridionalis Onivara Datepalm Mosobamboo Sweetcherry Europeanpear Valleyoak Corkoak Wildsugarcane Spiderflower))
(defparameter plants '(Ler Acoerulea Pineapple WheatD Ahalleri Ahypochondriacus Alyrata Cashew Asparagus Ara Amborella Mosobamboo Brachypodium Sugarbeet Boleracea_capitata Brapa_fpsc Oilseedrape Boleracea_oleracea Chinesecabbage Bstricta Carietinum_icc4958 Cacuminata Pigeonpea Cgigantea Csativa_pk Clementine Cgrandiflora Muskmelon Ccapsularis Papaya Quinoa Croseus Crubella Cucumber Sweetorange Tea Ccampestris Carnation Carrot Drotundata Egrandis Esalsugineum Fvesca_vesca Mtruncatula Sacredlotus Spiderflower Corkoak Mdomestica Ginkgo Soy Graimondii Sunflower Rubbertree Barley Hop Tomato Kfedtschenkoi Klaxiflora Lperrieri Ljaponicus Lettuce Flax Cassava Mguttatus Mpolymorpha Msinensis Banana Ntabacum_tn90 Rchinensis Oeuropaea_sylvestris Obarthii Obrachyantha Oglaberrima Olongistaminata Omeridionalis Onivara Opunctata Orufipogon Oryza Othomaeum Sweetcherry Datepalm Cannuum Paxillaris Phallii Mbalbisiana Moss Ppersica Oilpalm Poplar Switchgrass Commonbean Europeanpear Valleyoak Castorbean Rmultiflora Redsage Sorghumbicolor Sfallax Setaria Eggplant Selaginella Spennellii Soleracea Spirodela Wildsugarcane Potato Sviridis Cocoa Redclover Tparvula Breadwheat WheatA Grape Watermelon Corn Zmarina) "A list of all species in PMN14")
(defparameter coralcyc '(Xenia Spistillata Nvectensis Hvulgaris Epallida Adigitifera) "A list of all cnideria species in the coralcyc project")
(defparameter poaceae '(Barley Brachypodium Breadwheat Corn Lperrieri Msinensis Obrachyantha Oglaberrima Opunctata Orufipogon Oryza Othomaeum Phallii Setaria Sorghumbicolor Sviridis Switchgrass Wheata Wheatd) "A list of all PMN13 species in Poaceae")
(defparameter algae '(Olucimarinus Mpusilla Mcommoda Csubellipsoidea Czofingiensis Vcarteri Chlamy Cvariabilis))
(defparameter atted '(Ara Tomato Soy Oryza Corn Brapa_fpsc Grape Poplar Mtruncatula) "A list of species that are in the ATTED-II co-espression database")
(defparameter authors-pmn14 '(|xue| |schlapfer| |rhee| |zhang| |xu| |hawkins| |fryer|) "List of authors in PMN14")

; Functions for updating drupal info
(defun export-drupal-table (pgdbs file)
  "Writes a table file with the PGDB IDs, species names, versions, and counts of pathways, reactions, enzymes, compounds, and citations. This file can then be given to the python program drupal_table.py to generate the final drupal table"
  (to-file-or-stream file
		     (print-alist
		       stream
		       (cons '("Cyc" "TaxName" "Version" "Pathways" "Enzymes" "Reactions" "Compounds" "Citations")
			     (loop-orgids pgdbs
					  collect (list
						    org
						    (org-name)
						    (kb-version (find-kb org))
						    (length (gcai '|Pathways|))
						    (length (gcai '|Proteins|))
						    (length (gcai '|Reactions|))
						    (length (gcai '|Compounds|))
						    (length (gcai '|Publications|)))
					  closing)))))
(defun drupal-list-of-pgdbs (pgdbs file)
  "Exports the table for https://plantcyc.org/list-of-pgdbs as an html file"
  (to-file-or-stream file
		     (format stream "~A~%"
			     (alist-to-html-table
			       (cons '("DATABASE" "VERSION" "PATHWAYS" "ENZYMES" "REACTIONS" "COMPOUNDS" "CITATIONS")
				     (mapcar #'rest
				       (sort 
					     (loop-orgids pgdbs
							  collect (list
								    (org-name); This is only for sorting; it will be removed from the final table
								    (drupal-table-org-link)
								    (kb-version (find-kb org))
								    (length (gcai '|Pathways|))
								    (length (gcai '|Proteins|))
								    (length (gcai '|Reactions|))
								    (length (gcai '|Compounds|))
								    (length (gcai '|Publications|)))
							  closing)#'species< :key #'first)))))))
(defun species< (species1 species2)
  "Comparison of two species names that puts PlantCyc at the top but otherwise sorts by species name. Used in the drupal species table"
  (if (string-equal species2 "PlantCyc")
    nil
    (if (string-equal species1 "PlantCyc")
      0
      (string< species1 species2))))
(defun drupal-table-org-link (&optional (orgid (current-orgid)))
  "Returns a link to the given orgid with its species as the text"
  (so orgid)
  (html-tag "a" `("href" ,(format nil "https://pmn.plantcyc.org/organism-summary?object=~A" orgid)) (italicize-orgid-name orgid)))

; refine-a functions
(defun e2p2-enzrxn-citations (citation &key (kb (current-kb)))
  "Part of refine-a, this adds the given citation to all e2p2 enzrxns. For enzrs with old e2p2 citations it replaces them; for enzrxns with no citations it is added. <citation> should be the current E2P2 citation, formatted as \"E2P2PMN2024:EV-COMP-AINF\" but for the current year; this references frame PUB-E2P2PMN2024 which is created in AraCyc by (create-e2p2-citation) which in turn is called by (create-savi-citations), part of refine-prepare, and the resulting E2P2 frame is imported from AraCyc into each other database during refine-a before this function is called. This function was written to replace the e2p2_enzrxn_citations.pl script"
  (setq prev-org (current-orgid))
  (so (as-orgid kb))
  (loop for ezr in (all-enzrxns)
	for cit-list = (gsvs ezr 'citations)
	; There are three possibilities for an enzr: a new e2p2 enzr, an old e2p2 enzr, and a non-e2p2 enzr.
	; New e2p2 enzrs (id'd by having no existing citations) should have the new citation added. 
	; Old e2p2 enzrs (id'd by having one or more existing e2p2 citations) should have the old citations removed and the new e2p2 citation added
	; Non-e2p2 enzrs (id'd by having existing citations but none of them e2p2 citations) should not be changed
	when (or (= 0 (length cit-list))
		 (loop for old-cit in cit-list
		       with found-e2p2 = nil
		       when (excl:match-re e2p2-re old-cit)
		       do (remove-slot-value ezr 'citations old-cit)
		       and do (setq found-e2p2 t)
		       finally (return found-e2p2)))
	do (add-slot-value ezr 'citations citation))
  (so prev-org))

(defun copy-authors-from-aracyc (authors pgdbs)
  "Copies the author frames from aracyc to the other pgdbs"
  (let ((pgdbs (remove 'ara pgdbs))
        (aracyc (find-org 'ara)))
    (loop for cyc in pgdbs do
		  (so 'ara)
		  (so cyc)
          (import-frames :frames authors :src-kb aracyc :dst-kb (find-org cyc))
		  (close-kb :save-updates-p t :flush-memory-p t))))
(defun set-authors-for-pgdbs (authors pgdbs)
  "Sets the given author list as the authors for all pgdbs"
  (let ((pgdbs (remove 'ara pgdbs))
		(aracyc (find-org 'ara)))
	(loop for cyc in pgdbs do
		  (so 'ara)
		  (so cyc)
		  (import-frames :frames authors :src-kb aracyc :dst-kb (find-org cyc))
		  (put-slot-values cyc 'pgdb-authors authors)
		  (close-kb :save-updates-p t :flush-memory-p t))
	(when (find 'ara pgdbs)
	  (so 'ara)
	  (put-slot-values 'ara 'pgdb-authors authors))))
; Functions to add in dblinks
(defun add-dblink (db author &key (to (all-proteins)) filter (slot 'accession-1) modify)
  "Adds the given dblink to all proteins. DB should be the frame ID of a database object, e.g. 'PHYTOZOME. AUTHOR should be the author to credit, e.g. '|hawkins|. FILTER is a string; only proteins whose accession contains the string will receive the dblink. SLOT is the slot to take the accession from; goes into the dblink and also is used by FILTER. Proteins lacking this slot will not get the dblink"
  (loop for p in (expand-frameset to)
		for a = (gsv p slot)
		when modify
		do (setq a (funcall modify a))
		when a
		when (search filter a)
		do (add-slot-value p 'dblinks `(,db ,a nil ,author ,(get-universal-time) nil))
		count p))
				 
; Functions to generate the citations for SAVI (PUB-PMNUPP2019, etc.)

(defconstant *pmn-citations* '("PMNUPP" "PMNAIPP" "PMNRXN" "PMNRXNTAXON" "PMNTAXON" "PMNIC" "PMNSP" "E2P2PMN" "PMNCVP") "List of partial frame names for the savi citations, used when copying the citations from one PGDB to the others")
(defun copy-savi-citations (&key (year (util.date-time:date-time-year (util.date-time:ut-to-date-time (get-universal-time)))) (src-kb 'ara))
  "Copies all the SAVI citations for :year (by default the current year) from :src-kb (by default AraCyc) to the current kb"
  (let ((src-kb (as-kb src-kb))
		(dst-kb (current-kb)))
	(so (as-orgid src-kb))
	(so (as-orgid dst-kb))
	(import-frames :frames
				   (loop for cit-base in *pmn-citations*
						 collect (symbol (format nil "PUB-~A~A" cit-base year)))
				   :src-kb src-kb :dst-kb dst-kb)))
(defun create-savi-citations (&key
							   (year (util.date-time:date-time-year (util.date-time:ut-to-date-time (get-universal-time))))
							   (input-dir (sys:getenv "PMN_SAVI"))
							   e2p2-version
							   (ptools-version (ptools-version))
							   savi-version
							   (rpsd-version e2p2-version)
							   metacyc-version
							   (kb-list (list (current-kb))))
  "Creates the SAVI citations for the given year. The input-dir should point to the SAVI input directory containing CAPP.txt, etc."
  (let* ((org-list (mapcar #'as-orgid kb-list))
		 (src-org (first org-list))
		 (upp-version (read-savifile-version input-dir "UPP.txt"))
		 (aipp-version (read-savifile-version input-dir "AIPP.txt"))
		 (cvp-version (read-savifile-version input-dir "CVP.txt"))
		 (capp-version (read-savifile-version input-dir "CAPP.txt"))
		 (metacyc-version (if metacyc-version metacyc-version
							(progn (so 'meta) (kb-version (current-kb))))))
	(so src-org)
	(create-upp-citation year upp-version ptools-version)
	(create-aipp-citation year aipp-version ptools-version)
	(create-rxn-citation year capp-version e2p2-version ptools-version)
	(create-rxntaxon-citation year capp-version e2p2-version ptools-version)
	(create-taxon-citation year capp-version ptools-version)
	(create-ic-citation year upp-version ptools-version metacyc-version)
	(create-sp-citation year ptools-version savi-version)
	(create-e2p2-citation year e2p2-version rpsd-version)
	(create-cvp-citation year cvp-version ptools-version)
	(save-kb)
	(loop-orgids (rest org-list)
				 do (loop for cit-frame-part in *pmn-citations*
						  for cit-frame = (format nil "PUB-~A~A" cit-frame-part year)
						  when (coercible-to-frame-p cit-frame)
						  do (delete-frame cit-frame)
						  and do (format t "Replacing existing frame ~A in ~ACYC~%" cit-frame org)
						  do (copy-frame cit-frame cit-frame
										 :kb (find-kb src-org)
										 :new-kb (current-kb)))
				 )))

(defun create-upp-citation (year inputfile-version ptools-version)
  "Creates the SAVI citation for UPP for the given year"
  (create-savi-citation "PUB-PMNUPP" year
						(format nil "This pathway was predicted to exist in this species using PathoLogic (version ~A) and was accepted because it is a member of the set of Ubiquitous Land Plant Pathways (UPP version ~A)." ptools-version inputfile-version)))

(defun create-aipp-citation (year inputfile-version ptools-version)
  "Creates the SAVI citation for AIPP for the given year"
  (create-savi-citation "PUB-PMNAIPP" year
						(format NIL "This pathway was predicted to exist in this species using PathoLogic (version ~A) and was accepted because it is a member of the set of Accept If Predicted Pathways (AIPP version ~A)." ptools-version inputfile-version)))

(defun create-rxn-citation (year inputfile-version e2p2-version ptools-version)
  "Creates the SAVI citation for CAPP pathways predicted due to presence of key reactions for the given year"
  (create-savi-citation "PUB-PMNRXN" year
						(format NIL "This pathway, a member of the Conditionally Accepted PMN Pathways (CAPP version ~A), was predicted to exist in this species using PathoLogic (version ~A) and was accepted because its genome encodes enzyme(s) predicted by E2P2 (version ~A) to catalyze key reaction(s) in the pathway." inputfile-version ptools-version e2p2-version)))

(defun create-rxntaxon-citation (year inputfile-version e2p2-version ptools-version)
  "Creates the SAVI citation for CAPP pathways predicted due to presence of key reactions and the species' taxonomic position for the given year"
  (create-savi-citation "PUB-PMNRXNTAXON" year
						(format NIL "This pathway, a member of the Conditionally Accepted PMN Pathways (CAPP version ~A), was predicted to exist in this species using PathoLogic (version ~A) and was accepted because its genome encodes enzyme(s) predicted by E2P2 (version ~A) to catalyze key reaction(s) in the pathway. It also falls within an expected taxonomic range assigned to the pathway by PMN curators." inputfile-version ptools-version e2p2-version)))

(defun create-taxon-citation (year inputfile-version ptools-version)
 "Creates the SAVI citation for CAPP pathways predicted due to the species' taxonomic position for the given year"
   (create-savi-citation "PUB-PMNTAXON" year
						 (format NIL "This pathway, a member of the Conditionally Accepted PMN Pathways (CAPP version ~A), was predicted to exist in this species using PathoLogic (version ~A) and was accepted because it falls within an expected taxonomic range assigned to the pathway by PMN curators." inputfile-version ptools-version)))

(defun create-ic-citation (year inputfile-version ptools-version metacyc-version)
    (create-savi-citation "PUB-PMNIC" year
						  (format nil "This pathway was not predicted to exist in this species using PathoLogic (version ~A), but was imported from MetaCyc (version ~A) because it is a member of the set of Ubiquitous land Plant Pathways (UPP version ~A)." ptools-version metacyc-version inputfile-version)))

(defun create-sp-citation (year ptools-version savi-version)
    (create-savi-citation "PUB-PMNSP" year
						  (format nil "This superpathway was predicted to exist in this species using PathoLogic (version ~A). All of its sub-pathway(s) have been accepted using the SAVI (version ~A) pipeline. Please see the subpathways to determine the level of support for this superpathway in this species." ptools-version savi-version)))

(defun create-e2p2-citation (year e2p2-version rpsd-version)
    (create-savi-citation "PUB-E2P2PMN" year
						  (format nil "The functional annotation of protein sequences was performed by the PMN Ensemble Enzyme Prediction Pipeline (E2P2, version ~A). E2P2 annotates protein sequences using homology transfer by integrating both single sequence (BLAST, E-value cutoff <= 1e-2) and multiple sequence (Priam) models of enzymatic function. The ensemble algorithm relies on a maximum weighted integration scheme (absolute weight cutoff >= 0.5) where the weight of each predicted model was determined via a 5-by-3 nested cross-validation routine. The training of E2P2 and the reference databases used in the annotation process are based on the Reference Protein Sequence Dataset (RPSD, version ~A). Data for RPSD was compiled from protein sequences with experimental support of existence from SwissProta, MetaCyc, and BRENDA." e2p2-version rpsd-version)))

(defun create-cvp-citation (year inputfile-version ptools-version)
    (create-savi-citation "PUB-PMNCVP" year
						  (format nil "This pathway was predicted to exist in this species using PathoLogic (version 23.0) and was accepted because it is a member of the set of Common Viridiplantae Pathways (CVP version 5.0)." ptools-version inputfile-version)))

(defun create-savi-citation (frame-prefix year title)
  "Creates a SAVI citation for the given year"
  (let ((frame-name (format nil "~A~A" frame-prefix year)))
	(when (coercible-to-frame-p frame-name)
	  (format t "Replacing existing citation ~A in ~ACYC~%" frame-name (as-orgid (current-kb)))
	  (delete-frame frame-name))
	(create-frame frame-name :direct-types '("Publications") 
				  :own-slots
				  `((TITLE ,title)
					(URL "https://www.plantcyc.org/about/savi-pipeline")
					(YEAR ,year)))))

(defun read-savifile-version (dir whichfile)
  "Reads the version string from the specified savi file in the savi input directory"
  (let ((filename (make-pathname :directory (list :absolute dir "input") :name whichfile)))
	(format t "Reading from ~A (from ~A, ~A)~%" filename dir whichfile)
	(with-open-file (file filename :direction :input)
	  (let ((firstline (read-line file nil nil)))
		(unless firstline (error (format nil "File ~A is empty~%" filename)))
		(let ((fields (excl::split-re "\\t" firstline)))
		  (unless (>= (length fields) 2) (error "File ~A header line not formatted as expected:~%~A~%" filename firstline))
		  (second fields))))))

(defun list-of-pgdbs (pgdbs)
  "Creates a table for the list-of-pgdbs page"
  (setq pgdbs (for-orgids (cons 'plant pmn15) (flatten (list org (get-slot-value org 'common-name) (or (get-slot-value org 'strain-name) "") (true-kb-version) (mapcar (lx (length (get-class-all-instances x))) '("Pathways" "Polypeptides" "Reactions" "Compounds" "Publications")))))))

(defun rename-genes (mapfile &key (kb (current-kb)))
  "Reads in a .map file as produced by rename-genes.py, and sets the accession-1 fields of the genes in the current organism according to it"
  (let ((map (read-alist mapfile))
		(kb (if (kb-p kb) kb (find-kb kb))))
	(loop for (gene_acc prot_acc gene_id prot_id) in map
		  do (if (coercible-to-frame-p gene_id :kb kb)
			   (if (instance-all-instance-of-p gene_id '|Genes| :kb kb)
				 (progn (put-slot-value gene_id 'accession-1 gene_acc :kb kb)
						(format t "Info: Renaming gene ~A to ~A~%" gene_id gene_acc))
				 (format t "Warning: frame ~A is not a gene, ignoring~%" gene_id))
			   (format t "Warning: ~A is not a frame in the given kb~%" gene_id)))))

(defun new-author (frameid &key first middle last email (username (first (excl:split-re "@" email))) affiliation comment (kb 'ara) overwrite?)
  "Create an author frame without using the gui. If :overwrite? is false and a frame with id frameid already exists, then nothing is created"
  (let ((prev-kb (current-kb))
		(org (as-orgid kb)))
	(so org)
	(when (coercible-to-frame-p frameid)
	  (if overwrite?
		(let ((old-frame (coerce-to-frame frameid)))
		  (format t "Deleting existing frame ~A~%" (author-to-string old-frame))
		  (delete-frame old-frame))
		(progn (format t "Author frame ~A already exists in ~ACYC and :overwrite? is false; frame not created" (author-to-string frameid) org) (return-from new-author))))
	(let ((new-frame (create-instance (intern frameid) '(|People|)))
		  (affiliations (check-affiliations affiliation)))
	  (format t "got affiliations: ~A~%" affiliations)
	  (put-slot-value new-frame 'FIRST-NAME first)
	  (put-slot-value new-frame 'MIDDLE-NAME middle)
	  (put-slot-value new-frame 'LAST-NAME last)
	  (put-slot-value new-frame 'EMAIL email)
	  (put-slot-value new-frame 'LOGIN-ACCOUNT username)
	  (put-slot-values new-frame 'AFFILIATIONS affiliations)
	  (put-slot-value new-frame 'COMMENT comment)
	  (format t "Created author frame ~A in ~A~%" (author-to-string new-frame) org))))

(defun author-to-string (author)
  "Prints a single-line string representation of an author frame"
  (let ((author-frame (coerce-to-frame author)))
	(if author-frame
	  (if (instance-all-instance-of-p author-frame '|People|)
		(let ((affs (get-slot-values author-frame 'affiliations))
			  (middle (get-slot-value author-frame 'middle-name))
			  (comment (get-slot-value author-frame 'comment)))
		  (format nil "~A (~A~A~A; User Name: ~A; Email: ~A; Affiliation~A: ~{~A~^, ~}; ~ACredited in ~A frames)"
				  (get-frame-handle author-frame)
				  (get-slot-value author-frame 'first-name)
				  (if middle (format nil " ~A ") " ")
				  (get-slot-value author-frame 'last-name)
				  (get-slot-value author-frame 'login-account)
				  (get-slot-value author-frame 'email)
				  (if (= (length affs) 1) "" "s")
				  (to-handles affs)
				  (if comment (format nil "Comment: \"~A\"; " comment) "")
				  (length (get-slot-values author-frame 'credited-for))))
		(format nil "~A (not an author frame in ~ACYC)" (get-frame-handle author-frame) (as-orgid (current-kb))))
	  (format nil "~A (not a frame in ~ACYC)" author (as-orgid (current-kb))))))

(defun check-affiliations (affiliations)
  "Checks the affiliation or list of affiliations exists in the current database and returns as a list of frames. A non-list argument will be put into a single-element list. An error occurs if given something that is not a affiliation frame or list, or any list element is not an affiliation frame"
  (format t "affs: ~A~%" affiliations)
  (if (listp affiliations)
	(loop for aff in affiliations collect (check-affiliation aff))
	(list (check-affiliation affiliations))))

(defun check-affiliation (affiliation)
  "Checks that affiliation exists as a frame in the current kb and converts it to a frame. Error if it does not exist or is not an organization"
  (format t "aff: ~A~%" affiliation)
  (let ((frame-aff (coerce-to-frame affiliation)))
	(if frame-aff
	  (if (instance-all-instance-of-p frame-aff '|Organizations|)
		frame-aff
		(error (format nil "~A exists in ~ACYC but is not an organization frame" affiliation (as-orgid (current-kb)))))
	  (error (format nil "~A is not a frame in ~ACYC" affiliation (as-orgid (current-kb)))))))

; refine-c functions
(defun refine-c (&optional (pgdbs (list (as-orgid (current-kb)))))
  "Runs refine-c for the curent kb or the given list of kbs"
  (loop-orgids pgdbs
			   do (run-all-checks)
			      (update-overview :batch-mode? t :show-progress? nil :save? nil)
				  (fix-nil-names)
				  saving closing))

(defun make-overviews (&optional (pgdbs (list (as-orgid (current-kb)))))
  "Makes the cellular overview for all the given pgdbs"
  (for-orgids pgdbs (progn (update-overview :batch-mode? t :show-progress? nil :save? t) (save-kb))))

(defun fix-nil-names ()
  "Fixes the problem of protein names getting set to the string \"NIL\" rather than to NIL"
  (loop for p in (get-class-all-instances "Polypeptides")
		when (equal (get-slot-value p 'common-name) "NIL")
		do (put-slot-values p 'common-name nil)))

; Functions for the custom data dumps
(defun pmn-dump-compounds (file)
  "Does the custom PMN compound dump for one orgid"
  (to-file-or-stream
	file
	(format stream  "Compound_id	Compound_common_name	Compound_synonyms	Molecular_weight	Chemical_formula	Smiles	Links	EC	Reaction_equation	Pathway~%")
	(loop for c in (frames-referenced-as-cpds) do (pmn-dump-compound c stream))))

(defun pmn-dump-pathways (file)
  "Does the custom PMN pathway dump for one orgid"
  (to-file-or-stream
	file
	(format stream "Pathway-id	Pathway-name	Reaction-id	EC	Protein-id	Protein-name	Gene-id	Gene-name~%")
	(loop for p in (all-pathways) do (pmn-dump-pathway p stream))))

(defun pmn-dump-compound (c stream)
  "Returns a line for compound c for use in (pmn-dump-compounds)"
  (loop for r in (reactions-of-compound c)
		do (loop for p in (gsvs r 'in-pathway)
				 do (format stream "~S	~A	~{~A~^*~}	~A	~{~{~A~}~^ ~}	~A	~{~{~A~^:~}~^*~}	~A	~A	~A~%"
							(get-frame-handle c)
							(get-name-string c :strip-html? t)
							(gsvs c 'synonyms)
							(or (gsv c 'molecular-weight) "")
							(gsvs c 'chemical-formula)
							(or (gsv c 'smiles) "")
							(loop for l in (gsvs c 'dblinks) collect (subseq l 0 2))
							(or (gsv r 'ec-number) (format nil "~S" (gfh r)))
							(get-name-string r :strip-html? t)
							(get-name-string p :strip-html? t)))))
(defun pmn-dump-pathway (p stream)
  (loop for r in (reactions-of-pathway p)
	do (loop for e  in (enzymes-of-reaction r)
		 for g = (get-slot-value e 'gene)
		 do (format stream "~S	~A	~A	~A	~A	~A	~A	~A~%"
			    (get-frame-handle p)
			    (get-name-string p :strip-html? t)
			    (get-frame-handle r)
			    (get-slot-value r 'ec-number)
			    (get-frame-handle e)
			    (get-name-string e :strip-html? t)
			    (get-frame-handle g)
			    (get-name-string g :strip-html? t)))))

(defun frames-referenced-as-cpds ()
  "Returns a list of all frames referenced as if they were compounds in at least one pathway"
  (loop for p in (gcai '|Pathways|)
		with s = (empty-set)
		do (add-list-to-set (compounds-of-pathway p) s)
		finally (return (set-to-list s))))
